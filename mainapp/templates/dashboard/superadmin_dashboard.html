{% extends "base.html" %}
{% block content %}
<div class="flex items-center justify-center min-h-screen">
    <div class="w-full max-w-7xl p-8 bg-gray-800 rounded-2xl shadow-2xl">
        <h2 class="text-3xl font-bold mb-8 text-center text-purple-400 tracking-tight"><i class="fas fa-crown mr-2"></i>Super Admin Dashboard</h2>

        <!-- Stats Section -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" data-aos="fade-up">
            <div class="bg-gradient-to-br from-purple-400 to-purple-500 text-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-semibold">Total Users</h3>
                    <i class="fas fa-users text-2xl opacity-70"></i>
                </div>
                <p class="text-4xl font-bold mt-2">{{ total_users }}</p>
                <div class="w-full h-1 bg-white bg-opacity-20 mt-4 rounded-full overflow-hidden">
                    <div class="h-full bg-white bg-opacity-40 rounded-full" style="width: 85%"></div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-purple-400 to-purple-500 text-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-semibold">Total Events</h3>
                    <i class="fas fa-calendar-alt text-2xl opacity-70"></i>
                </div>
                <p class="text-4xl font-bold mt-2">{{ total_events }}</p>
                <div class="w-full h-1 bg-white bg-opacity-20 mt-4 rounded-full overflow-hidden">
                    <div class="h-full bg-white bg-opacity-40 rounded-full" style="width: 75%"></div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-purple-400 to-purple-500 text-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-semibold">Total Bookings</h3>
                    <i class="fas fa-ticket-alt text-2xl opacity-70"></i>
                </div>
                <p class="text-4xl font-bold mt-2">{{ total_bookings }}</p>
                <div class="w-full h-1 bg-white bg-opacity-20 mt-4 rounded-full overflow-hidden">
                    <div class="h-full bg-white bg-opacity-40 rounded-full" style="width: 60%"></div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-purple-400 to-purple-500 text-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-semibold">Departments</h3>
                    <i class="fas fa-building text-2xl opacity-70"></i>
                </div>
                <p class="text-4xl font-bold mt-2">{{ total_departments }}</p>
                <div class="w-full h-1 bg-white bg-opacity-20 mt-4 rounded-full overflow-hidden">
                    <div class="h-full bg-white bg-opacity-40 rounded-full" style="width: 40%"></div>
                </div>
            </div>
        </div>

        <!-- Manage Departments Section -->
        <div class="mt-10" data-aos="fade-up" data-aos-delay="100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-purple-400"><i class="fas fa-building mr-2"></i>Manage Departments</h3>
                <div class="flex gap-4 items-center">
                    <input type="text" id="departmentSearch" placeholder="Search departments..." class="bg-gray-700 text-white px-4 py-2 rounded-lg border border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-400">
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="departmentToggle" class="sr-only peer" onchange="toggleDepartments()">
                        <div class="w-14 h-7 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-purple-400"></div>
                        <span class="ml-3 text-sm font-medium text-white">Show All</span>
                    </label>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for department in departments %}
                    <div class="bg-gray-700 text-white p-6 rounded-lg shadow-lg department-card" data-has-active-events="{{ department.has_active_events }}" style="display: block">
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="text-xl font-semibold">{{ department.name }}</h4>
                            <span class="px-2 py-1 bg-purple-400 text-xs text-white rounded-full">{{ department.code }}</span>
                        </div>
                        <p class="text-gray-400 mt-2">Department Code: {{ department.code }}</p>
                        <div class="mt-4 flex justify-between items-center">
                            <span class="text-purple-400"><i class="fas fa-users mr-1"></i>{{ department.users_count }} users</span>
                            <a href="{% url 'department_details' department.id %}" class="text-purple-400 hover:text-purple-300 flex items-center">
                                <span>View Details</span>
                                <i class="fas fa-arrow-right ml-1"></i>
                            </a>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div class="mt-6 text-center">
                <a href="{% url 'create_department' %}" class="inline-block bg-purple-400 text-white px-6 py-3 rounded-lg hover:bg-purple-300 transition transform hover:-translate-y-1 hover:shadow-lg">
                    <i class="fas fa-plus-circle mr-2"></i>Create New Department
                </a>
            </div>
        </div>

        <!-- Manage Users Section -->
        <div class="mt-10" data-aos="fade-up" data-aos-delay="200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-purple-400"><i class="fas fa-users-cog mr-2"></i>Manage Users</h3>
                <div class="flex gap-4 items-center">
                    <input type="text" id="userSearch" placeholder="Search users..." class="bg-gray-700 text-white px-4 py-2 rounded-lg border border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-400">
                    <div class="flex items-center gap-4">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="radio" name="userRole" value="all" class="sr-only peer" onchange="filterUsers('all')" checked>
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-400"></div>
                            <span class="ml-2 text-sm font-medium text-white">All</span>
                        </label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="radio" name="userRole" value="student" class="sr-only peer" onchange="filterUsers('student')">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-400"></div>
                            <span class="ml-2 text-sm font-medium text-white">Students</span>
                        </label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="radio" name="userRole" value="admin" class="sr-only peer" onchange="filterUsers('admin')">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-400"></div>
                            <span class="ml-2 text-sm font-medium text-white">Teachers</span>
                        </label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="radio" name="userRole" value="superadmin" class="sr-only peer" onchange="filterUsers('superadmin')">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-400"></div>
                            <span class="ml-2 text-sm font-medium text-white">Admins</span>
                        </label>
                    </div>
                </div>
            </div>
            <div id="userGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for user in users %}
                    <div class="bg-gray-700 text-white p-6 rounded-lg shadow-lg user-card" data-role="{{ user.role }}" style="display: block;">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="w-12 h-12 bg-purple-400 rounded-full flex items-center justify-center text-white font-bold">
                                {{ user.username|first|upper }}
                            </div>
                            <div>
                                <h4 class="text-xl font-semibold">{{ user.username }}</h4>
                                <p class="text-purple-400 text-sm">{{ user.role }}</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-4">
                            <span class="text-gray-400 text-sm"><i class="fas fa-envelope mr-1"></i>{{ user.email }}</span>
                            <a href="{% url 'user_details' user.id %}" class="text-purple-400 hover:text-purple-300 flex items-center">
                                <span>View Details</span>
                                <i class="fas fa-arrow-right ml-1"></i>
                            </a>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div class="mt-6 text-center">
                <a href="{% url 'create_user' %}" class="inline-block bg-purple-400 text-white px-6 py-3 rounded-lg hover:bg-purple-300 transition transform hover:-translate-y-1 hover:shadow-lg">
                    <i class="fas fa-user-plus mr-2"></i>Create New User
                </a>
            </div>
        </div>

        <!-- System Settings Section -->
        <div class="mt-10 text-center p-6 bg-gray-700 rounded-lg shadow-lg" data-aos="fade-up" data-aos-delay="300">
            <h3 class="text-xl font-semibold text-purple-400 mb-2"><i class="fas fa-cogs mr-2"></i>System Settings</h3>
            <p class="text-gray-400 mb-4">Configure system-wide settings and perform maintenance tasks.</p>
            <div class="flex flex-wrap justify-center gap-4">
                <a href="{% url 'admin_settings' %}" class="inline-block bg-purple-400 text-white px-4 py-2 rounded-lg hover:bg-purple-300 transition transform hover:-translate-y-1 hover:shadow-lg">
                    <i class="fas fa-sliders-h mr-1"></i>Settings
                </a>
                <a href="{% url 'admin_logs' %}" class="inline-block bg-purple-400 text-white px-4 py-2 rounded-lg hover:bg-purple-300 transition transform hover:-translate-y-1 hover:shadow-lg">
                    <i class="fas fa-list-alt mr-1"></i>View Logs
                </a>
                <a href="{% url 'admin_backup' %}" class="inline-block bg-purple-400 text-white px-4 py-2 rounded-lg hover:bg-purple-300 transition transform hover:-translate-y-1 hover:shadow-lg">
                    <i class="fas fa-database mr-1"></i>Backup
                </a>
            </div>
        </div>
    </div>
</div>
<script>
    // Department filtering functionality
    const departmentSearch = document.getElementById('departmentSearch');
    const departments = document.getElementsByClassName('department-card');
    let showAllDepartments = false;

    departmentSearch.addEventListener('input', function() {
        filterDepartments(this.value.toLowerCase());
    });

    function filterDepartments(searchTerm = '') {
        Array.from(departments).forEach(dept => {
            const title = dept.querySelector('h4').textContent.toLowerCase();
            const hasActiveEvents = dept.dataset.hasActiveEvents === 'true';
            const matchesSearch = title.includes(searchTerm);
            dept.style.display = matchesSearch && (showAllDepartments || hasActiveEvents) ? 'block' : 'none';
            dept.style.transition = 'all 0.3s ease-in-out';
            dept.style.opacity = dept.style.display === 'block' ? '1' : '0';
        });
    }

    function toggleDepartments() {
        showAllDepartments = document.getElementById('departmentToggle').checked;
        filterDepartments(departmentSearch.value.toLowerCase());
    }

    // User search and filter functionality
    const userSearch = document.getElementById('userSearch');
    const userGrid = document.getElementById('userGrid');
    let currentUserFilter = 'all';

    userSearch.addEventListener('input', function() {
        updateUsers(currentUserFilter, this.value);
    });

    function filterUsers(role) {
        currentUserFilter = role;
        const radios = document.querySelectorAll('[name="userRole"]');
        radios.forEach(radio => {
            const peer = radio.parentElement.querySelector('.peer');
            if (radio.value === role) {
                radio.checked = true;
                peer.classList.add('bg-purple-400');
                peer.classList.remove('bg-gray-600');
            } else {
                radio.checked = false;
                peer.classList.remove('bg-purple-400');
                peer.classList.add('bg-gray-600');
            }
        });
        updateUsers(role, userSearch.value);
    }

    function updateUsers(role, search) {
        const params = new URLSearchParams();
        if (role && role !== 'all') params.append('role', role);
        if (search) params.append('search', search);

        fetch(`/filter-users/?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data && data.html) {
                    userGrid.innerHTML = data.html;
                } else {
                    console.error('Invalid response data');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                userGrid.innerHTML = '<div class="text-red-500 p-4">Error loading users. Please try again.</div>';
            });
    }
    }

    // Initialize with active event departments and all users visible
    window.addEventListener('load', function() {
        document.getElementById('departmentToggle').checked = false;
        showAllDepartments = false;
        filterDepartments();
        filterUsers('all');
    });
</script>
{% endblock %}
